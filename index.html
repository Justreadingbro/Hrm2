<script>
  let mapInitialized = false; // Track if map is initialized

  // Function to fetch and display heart rate and location data
  function updateData() {
    const channelId = "2765312";  // Replace with your actual ThingSpeak Channel ID
    const apiKey = "WPQAF4KMIF5SNCGD";  // Replace with your actual ThingSpeak Read API Key if needed
    const url = `https://api.thingspeak.com/channels/${channelId}/feeds.json?api_key=${apiKey}&results=1`;

    fetch(url)
      .then(response => response.json())
      .then(data => {
        const feeds = data.feeds[0];
        const heartRate = feeds.field1;
        const latitude = feeds.field3;  // Location data sent to ThingSpeak
        const longitude = feeds.field4; // Location data sent to ThingSpeak

        // Update heart rate and location on the page
        document.getElementById('heartRate').innerText = heartRate + ' BPM';
        document.getElementById('latitude').textContent = `Latitude: ${latitude}`;
        document.getElementById('longitude').textContent = `Longitude: ${longitude}`;
        document.getElementById('mapsLink').href = `https://www.openstreetmap.org/?mlat=${latitude}&mlon=${longitude}#map=18/${latitude}/${longitude}`;
        document.getElementById('mapsLink').textContent = 'Open in OpenStreetMap';
        document.getElementById('location').style.display = 'block';

        // Initialize map only once
        if (!mapInitialized) {
          const map = document.getElementById('map');
          map.style.display = 'block';
          const leafletMap = L.map('map').setView([latitude, longitude], 13);
          L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
          }).addTo(leafletMap);
          L.marker([latitude, longitude]).addTo(leafletMap)
            .bindPopup(`Latitude: ${latitude}<br>Longitude: ${longitude}`)
            .openPopup();

          mapInitialized = true; // Mark the map as initialized
        }

        // Display alert if heart rate is above 80 or below 50
        if (heartRate > 80 || heartRate < 50) {
          document.getElementById('alert').style.display = 'block';  // Show alert
        } else {
          document.getElementById('alert').style.display = 'none';  // Hide alert
        }
      })
      .catch(error => {
        console.error('Error fetching data:', error);
        document.getElementById('heartRate').innerText = 'Error';
      });

    setTimeout(updateData, 5000);  // Update every 5 seconds
  }

  window.onload = function() {
    updateData();
  };
</script>
